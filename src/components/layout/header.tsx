"use client";

import Link from "next/link";
import Image from "next/image";
import { useState, useEffect } from "react";
import { useRouter, usePathname } from "next/navigation";
import { ChevronDown, User, LogOut, Menu, Bell, HelpCircle } from "lucide-react"; // ✅ Added Menu icon for hamburger

import { useAuth } from "@/lib/hooks/use-auth";
import { toast } from "react-hot-toast";
import { motion, AnimatePresence } from "framer-motion";

export function Header() {
  const router = useRouter();
  const pathname = usePathname();
  const { user, isAuthenticated, checkAuth, logout } = useAuth();
  const [isDropdownOpen, setIsDropdownOpen] = useState(false);
  const [isLgUp, setIsLgUp] = useState(false); // ✅ detect screen size
  const [activeCardName, setActiveCardName] = useState<string>("");

  const getInitials = (value?: string | null) => {
    if (!value) return "U";
    const base = value.includes("@") ? value.split("@")[0] : value;
    const letters = base
      .split(" ")
      .filter(Boolean)
      .map((part) => part[0])
      .join("")
      .toUpperCase()
      .slice(0, 2);
    return letters || "U";
  };

  // ✅ Detect large screen
  useEffect(() => {
    const mql = window.matchMedia("(min-width: 1024px)");
    const onChange = () => setIsLgUp(mql.matches);
    onChange();
    mql.addEventListener("change", onChange);
    return () => mql.removeEventListener("change", onChange);
  }, []);

  // Fetch user's active card
  useEffect(() => {
    const fetchActiveCard = async () => {
      if (!isAuthenticated) return;
      
      try {
        const response = await fetch('/api/card');
        if (response.ok) {
          const data = await response.json();
          if (data.success && data.cards && data.cards.length > 0) {
            // Get the first active card
            const activeCard = data.cards.find((card: any) => card.cardActive !== false);
            if (activeCard) {
              setActiveCardName(activeCard.cardName || "My Card");
            }
          }
        }
      } catch (error) {
        console.error("Error fetching active card:", error);
      }
    };

    fetchActiveCard();
  }, [isAuthenticated]);

  // Ensure auth check runs on mount
  useEffect(() => {
    checkAuth();
  }, [checkAuth]);

  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      const target = event.target as HTMLElement | null;
      if (!target) return;

      if (!target.closest('[data-profile-menu]')) {
        setIsDropdownOpen(false);
      }
    }

    if (isDropdownOpen) {
      document.addEventListener("mousedown", handleClickOutside);
    }

    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, [isDropdownOpen]);

  // Dynamic page title
  const getPageTitle = () => {
    const path = pathname.split("/").filter(Boolean);
    if (path.length === 0) return "Home";
    const pageName = path[path.length - 1];
    return pageName.charAt(0).toUpperCase() + pageName.slice(1);
  };

  const handleLogout = async () => {
    try {
      await logout();
      toast.success("Logged out successfully");
      router.push("/auth/login");
      setIsDropdownOpen(false);
    } catch (error) {
      toast.error("Logout failed");
    }
  };

  return (
    <>
      {/* HEADER WRAPPER */}
      <header
        className="bg-white/95 backdrop-blur-sm shadow-sm border-b border-gray-200/50 sticky top-0 z-50"
        style={!isLgUp ? { paddingTop: "4px" } : undefined}
      >
        <div className="max-w-7xl mx-auto">
        <div
          className="flex justify-between items-center h-14 px-4 relative"
        >

  {/* LEFT AREA — Hamburger goes here only on mobile */}
  <div
    className="flex items-center"
    style={!isLgUp ? { paddingLeft: "10px" } : undefined}
  >
    {!isLgUp && (
      <Link href="/dashboard">
        <Image
          src="/assets/headerlogo.png"
          alt="Logo"
          width={120}
          height={32}
          className="h-8 w-auto object-contain"
        />
      </Link>
    )}
  </div>

            {/* RIGHT SIDE - Notifications & Profile */}
            <div
              style={{
                display: "flex",
                alignItems: "center",
                justifyContent: "flex-end",
                gap: "16px",
                paddingRight: "32px",
              }}
            >
              {/* Notifications icon in header (desktop & mobile) */}
              <Link
                href="/dashboard/notifications"
                className="relative flex items-center justify-center"
              >
                <Bell className="w-5 h-5 text-gray-500 hover:text-blue-600 transition-colors" />
              </Link>

              <div className="relative" data-profile-menu>
                {isLgUp ? (
                  <motion.button
                    onClick={() => setIsDropdownOpen(!isDropdownOpen)}
                    whileHover={{ scale: 1.02 }}
                    whileTap={{ scale: 0.98 }}
                    style={{
                      width: "36px",
                      height: "36px",
                      borderRadius: "50%",
                      background: user?.profileImage
                        ? "transparent"
                        : "linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)",
                      border: "2px solid white",
                      boxShadow: "0 2px 8px rgba(0, 0, 0, 0.15)",
                      display: "flex",
                      alignItems: "center",
                      justifyContent: "center",
                      flexShrink: 0,
                      overflow: "hidden",
                    }}
                  >
                    {user?.profileImage ? (
                      <img
                        src={user.profileImage}
                        alt="Profile"
                        style={{
                          width: "100%",
                          height: "100%",
                          objectFit: "cover",
                        }}
                      />
                    ) : (
                      <span
                        style={{
                          fontSize: "14px",
                          fontWeight: 600,
                          color: "#ffffff",
                        }}
                      >
                        {getInitials(user?.fullName || user?.email || "")}
                      </span>
                    )}
                  </motion.button>
                ) : (
                  <motion.button
                    onClick={() => setIsDropdownOpen(!isDropdownOpen)}
                    whileHover={{ scale: 1.05 }}
                    whileTap={{ scale: 0.95 }}
                    style={{
                      width: "44px",
                      height: "44px",
                      borderRadius: "9999px",
                      background: user?.profileImage
                        ? "transparent"
                        : "linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)",
                      border: "1px solid rgba(147, 197, 253, 0.5)",
                      boxShadow:
                        "0 6px 18px rgba(37, 99, 235, 0.35), inset 0 0 12px rgba(147, 197, 253, 0.35)",
                      display: "flex",
                      alignItems: "center",
                      justifyContent: "center",
                      padding: 0,
                      cursor: "pointer",
                    }}
                    aria-label="Open profile menu"
                  >
                    {user?.profileImage ? (
                      <img
                        src={user.profileImage}
                        alt="Profile"
                        style={{
                          width: "100%",
                          height: "100%",
                          objectFit: "cover",
                          borderRadius: "9999px",
                        }}
                      />
                    ) : (
                      <span
                        style={{
                          fontSize: "16px",
                          fontWeight: 600,
                          color: "#ffffff",
                        }}
                      >
                        {getInitials(user?.fullName || user?.email || "")}
                      </span>
                    )}
                  </motion.button>
                )}
                {/* DROPDOWN MENU - shows Help & Support, Account, Logout on all screen sizes */}
                <AnimatePresence>
                  {isDropdownOpen && (
                    <motion.div
                      initial={{ opacity: 0, y: -8, scale: 0.96 }}
                      animate={{ opacity: 1, y: 0, scale: 1 }}
                      exit={{ opacity: 0, y: -8, scale: 0.96 }}
                      transition={{ duration: 0.25, ease: "easeOut" }}
                      style={{
                        position: "absolute",
                        right: "0",
                        marginTop: "8px",
                        width: "220px",
                        maxWidth: "calc(100vw - 32px)",
                        background: "rgba(255, 255, 255, 0.98)",
                        backdropFilter: "blur(8px)",
                        border: "1px solid rgba(229, 231, 235, 0.5)",
                        borderRadius: "12px",
                        boxShadow: "0 10px 30px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(147, 197, 253, 0.25) inset",
                        paddingTop: "10px",
                        paddingBottom: "10px",
                        zIndex: 9999,
                        transform: "translateX(-16px)",
                      }}
                    >
                      <Link
                        href="/dashboard/support"
                        onClick={() => setIsDropdownOpen(false)}
                        style={{
                          display: "flex",
                          alignItems: "center",
                          gap: "12px",
                          padding: "12px 16px",
                          margin: "6px 0",
                          fontSize: "14px",
                          color: "#374151",
                          textDecoration: "none",
                          transition: "all 0.2s ease",
                          borderRadius: "8px",
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.backgroundColor = "#eff6ff";
                          e.currentTarget.style.color = "#1d4ed8";
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.backgroundColor = "transparent";
                          e.currentTarget.style.color = "#374151";
                        }}
                      >
                        <HelpCircle style={{ width: "16px", height: "16px" }} />
                        <span>Help & Support</span>
                      </Link>
                      <Link
                        href="/dashboard/settings"
                        onClick={() => setIsDropdownOpen(false)}
                        style={{
                          display: "flex",
                          alignItems: "center",
                          gap: "12px",
                          padding: "12px 16px",
                          margin: "6px 0",
                          fontSize: "14px",
                          color: "#374151",
                          textDecoration: "none",
                          transition: "all 0.2s ease",
                          borderRadius: "8px",
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.backgroundColor = "#eff6ff";
                          e.currentTarget.style.color = "#1d4ed8";
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.backgroundColor = "transparent";
                          e.currentTarget.style.color = "#374151";
                        }}
                      >
                        <User style={{ width: "16px", height: "16px" }} />
                        <span>Account</span>
                      </Link>
                      <button
                        onClick={handleLogout}
                        style={{
                          width: "100%",
                          display: "flex",
                          alignItems: "center",
                          gap: "12px",
                          padding: "12px 16px",
                          margin: "6px 0",
                          fontSize: "14px",
                          color: "#dc2626",
                          backgroundColor: "transparent",
                          border: "none",
                          textAlign: "left",
                          cursor: "pointer",
                          transition: "all 0.2s ease",
                          borderRadius: "8px",
                        }}
                        onMouseEnter={(e) => {
                          e.currentTarget.style.backgroundColor = "#fef2f2";
                        }}
                        onMouseLeave={(e) => {
                          e.currentTarget.style.backgroundColor = "transparent";
                        }}
                      >
                        <LogOut style={{ width: "16px", height: "16px" }} />
                        <span>Logout</span>
                      </button>
                    </motion.div>
                  )}
                </AnimatePresence>
              </div>
            </div>
          </div>
        </div>

        {/* Spacer */}
        <div style={{ height: "8px", visibility: "hidden" }}></div>
      </header>
    </>
  );
}